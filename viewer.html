<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Previsualización</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-family: system-ui, sans-serif; }
    .float-home { position: fixed; top: 12px; left: 12px; z-index: 9999; width: 44px; height: 44px; }
    .float-home a { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background: #333; color: #fff; border-radius: 50%; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,.3); transition: background .15s, transform .15s; }
    .float-home a:hover { background: #555; transform: scale(1.05); }
    .float-home svg { width: 22px; height: 22px; fill: currentColor; }
    .frame-wrap { flex: 1; min-height: 0; }
    .frame-wrap iframe { width: 100%; height: 100%; border: none; display: block; }
    .no-src { padding: 2rem; color: #c62828; }
  </style>
</head>
<body>
  <div class="float-home">
    <a href="index.html" title="Volver a menú de visualizaciones">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </a>
  </div>
  <div class="frame-wrap" id="frame-wrap">
    <iframe id="mock-frame" title="Mock"></iframe>
  </div>
  <div id="no-src" class="no-src" style="display: none; margin-top: 60px; padding: 2rem;">No se indicó previsualización (parámetro <code>src</code>). <a href="index.html">Volver al menú</a>.</div>

  <script>
    (function () {
      var params = new URLSearchParams(window.location.search);
      var src = params.get('src');
      var frameWrap = document.getElementById('frame-wrap');
      var frame = document.getElementById('mock-frame');
      var noSrc = document.getElementById('no-src');

      if (!src || src.trim() === '') {
        frameWrap.style.display = 'none';
        noSrc.style.display = 'block';
        return;
      }
      src = src.trim();
      if (src.indexOf('http://') === 0 || src.indexOf('https://') === 0 || src.indexOf('//') === 0) {
        frameWrap.style.display = 'none';
        noSrc.innerHTML = 'Solo se permiten rutas relativas. <a href="index.html">Volver al menú</a>.';
        noSrc.style.display = 'block';
        return;
      }
      frame.src = src;

      function normalizeSlash(s) {
        return (s || '').replace(/\\/g, '/');
      }

      function syncViewerUrl(relativePath) {
        if (!relativePath || relativePath.trim() === '') return;
        try {
          var u = new URL(window.location.href);
          u.search = '?src=' + encodeURIComponent(relativePath.trim());
          window.history.replaceState({}, '', u.toString());
        } catch (e) {}
      }

      frame.addEventListener('load', function () {
        try {
          var path = frame.contentWindow.location.pathname;
          if (!path) return;
          path = normalizeSlash(path);
          if (path.charAt(0) === '/') path = path.slice(1);
          var base = normalizeSlash(window.location.pathname);
          var baseDir = base.lastIndexOf('/') !== -1 ? base.slice(0, base.lastIndexOf('/') + 1) : '/';
          var baseDirTrim = baseDir.charAt(0) === '/' ? baseDir.slice(1) : baseDir;
          var relativePath = baseDirTrim.length && path.indexOf(baseDirTrim) === 0
            ? path.slice(baseDirTrim.length)
            : path;
          syncViewerUrl(relativePath);
        } catch (e) {
          /* iframe cross-origin o file://: esperar postMessage viewer-sync */
        }
      });

      window.addEventListener('message', function (ev) {
        if (ev.data && ev.data.type === 'viewer-sync' && typeof ev.data.path === 'string') {
          syncViewerUrl(ev.data.path);
        }
      });
    })();
  </script>
</body>
</html>
